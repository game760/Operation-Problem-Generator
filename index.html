<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>运算题生成器</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4338CA',
            secondary: '#10B981',
            accent: '#F59E0B',
            neutral: '#F3F4F6',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          boxShadow: {
            'card': '0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03)',
            'card-hover': '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04)',
          }
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .btn-effect {
        @apply transition-all duration-300 hover:shadow-lg transform hover:-translate-y-0.5 active:translate-y-0;
      }
      .input-focus {
        @apply focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all outline-none;
      }
      .setting-group {
        @apply mb-6 pb-6 border-b border-gray-100 last:border-0 last:mb-0 last:pb-0;
      }
      .fade-in {
        animation: fadeIn 0.5s ease-in-out;
      }
      .page-shadow {
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1), 0 0 0 1px rgba(0, 0, 0, 0.05);
      }
      .page-transition {
        transition: all 0.3s ease;
      }
      .page-transition:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
      }
      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen font-sans text-gray-800">
  <!-- 顶部导航 -->
  <header class="bg-white shadow-sm sticky top-0 z-50 transition-all duration-300">
    <div class="container mx-auto px-4 py-4 flex justify-between items-center">
      <div class="flex items-center space-x-3">
        <div class="bg-primary/10 p-2 rounded-lg">
          <i class="fa fa-calculator text-primary text-xl"></i>
        </div>
        <h1 class="text-xl md:text-2xl font-bold bg-gradient-to-r from-primary to-secondary bg-clip-text text-transparent">运算题生成器</h1>
      </div>
      <div class="text-sm text-gray-500 hidden md:block">
        灵活定制 · 专业排版 · 高效练习
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 py-8 max-w-7xl">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 lg:gap-8">
      <!-- 左侧设置面板 -->
      <div class="lg:col-span-1">
        <div class="bg-white rounded-xl shadow-card p-6 transition-all duration-300 hover:shadow-card-hover transform hover:-translate-y-1">
          <h2 class="text-lg font-semibold text-gray-800 mb-6 flex items-center">
            <i class="fa fa-sliders text-primary mr-2"></i> 题目设置
          </h2>
          
          <!-- 使用提醒 -->
          <div class="bg-amber-50 border-l-4 border-amber-400 p-4 mb-6 rounded-r-lg">
            <div class="flex">
              <div class="flex-shrink-0">
                <i class="fa fa-lightbulb-o text-amber-500"></i>
              </div>
              <div class="ml-3">
                <p class="text-sm text-amber-700">
                  <strong>使用提醒：</strong>请根据右侧预览调整题数、字号、行列设置等，亦可通过观察生成PDF进行调整，最终完美再进行打印。
                </p>
              </div>
            </div>
          </div>
          
          <!-- 题目数量设置（默认240） -->
          <div class="setting-group">
            <label for="questionCount" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fa fa-list-ol text-primary mr-1"></i> 题目数量
            </label>
            <div class="flex items-center">
              <input 
                type="number" 
                id="questionCount" 
                min="1" 
                max="500" 
                value="240" 
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg input-focus"
              >
              <span class="ml-2 text-gray-500">题</span>
            </div>
          </div>
          
          <!-- 数字范围设置 -->
          <div class="setting-group">
            <label for="numberRange" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fa fa-arrows-h text-primary mr-1"></i> 数字范围（以内）
            </label>
            <div class="flex items-center">
              <input 
                type="number" 
                id="numberRange" 
                min="10" 
                max="1000" 
                step="10"
                value="20" 
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg input-focus"
              >
              <span class="ml-2 text-gray-500">以内</span>
            </div>
          </div>
          
          <!-- 纸张大小设置（只保留A4） -->
          <div class="setting-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fa fa-file-o text-primary mr-1"></i> 纸张大小
            </label>
            <div class="grid grid-cols-1 gap-3">
              <div class="relative">
                <input 
                  type="radio" 
                  id="paperA4" 
                  name="paperSize" 
                  value="a4" 
                  checked
                  class="sr-only peer"
                >
                <label 
                  for="paperA4" 
                  class="block text-center px-3 py-2.5 border border-gray-300 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-primary/5"
                >
                  A4 (210×297mm)
                </label>
              </div>
            </div>
          </div>
          
          <!-- 字号设置（默认14px） -->
          <div class="setting-group">
            <label for="fontSize" class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fa fa-text-height text-primary mr-1"></i> 字号大小
            </label>
            <div class="flex items-center">
              <input 
                type="number" 
                id="fontSize" 
                min="8" 
                max="24" 
                value="14" 
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg input-focus"
              >
              <span class="ml-2 text-gray-500">px</span>
            </div>
          </div>
          
          <!-- 行列设置（行数默认40，列数默认6） -->
          <div class="setting-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fa fa-th text-primary mr-1"></i> 行列设置
            </label>
            <div class="grid grid-cols-2 gap-3">
              <div class="flex items-center">
                <label for="rowCount" class="text-sm text-gray-700 mr-2">行数:</label>
                <input 
                  type="number" 
                  id="rowCount" 
                  min="5" 
                  max="40" 
                  value="40" 
                  class="w-full px-3 py-2.5 border border-gray-300 rounded-lg input-focus"
                >
              </div>
              <div class="flex items-center">
                <label for="colCount" class="text-sm text-gray-700 mr-2">列数:</label>
                <input 
                  type="number" 
                  id="colCount" 
                  min="1" 
                  max="6" 
                  value="6" 
                  class="w-full px-3 py-2.5 border border-gray-300 rounded-lg input-focus"
                >
              </div>
            </div>
          </div>
          
          <!-- 答案设置 -->
          <div class="setting-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fa fa-check-square-o text-primary mr-1"></i> 答案设置
            </label>
            <div class="space-y-3">
              <div class="flex items-center">
                <input 
                  type="checkbox" 
                  id="includeAnswers" 
                  checked 
                  class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary"
                >
                <label for="includeAnswers" class="ml-2 text-sm text-gray-700">导出时包含答案</label>
              </div>
              <div class="flex items-center">
                <input 
                  type="checkbox" 
                  id="answersOnNewPage" 
                  checked 
                  class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary"
                >
                <label for="answersOnNewPage" class="ml-2 text-sm text-gray-700">答案单独占页</label>
              </div>
            </div>
          </div>
          
          <!-- 运算类型设置 -->
          <div class="setting-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fa fa-calculator text-primary mr-1"></i> 运算类型
            </label>
            <div class="grid grid-cols-2 gap-3">
              <div class="flex items-center">
                <input type="checkbox" id="addition" checked class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                <label for="addition" class="ml-2 text-sm text-gray-700">加法 (+)</label>
              </div>
              <div class="flex items-center">
                <input type="checkbox" id="subtraction" checked class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                <label for="subtraction" class="ml-2 text-sm text-gray-700">减法 (-)</label>
              </div>
              <div class="flex items-center">
                <input type="checkbox" id="multiplication" checked class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                <label for="multiplication" class="ml-2 text-sm text-gray-700">乘法 (×)</label>
              </div>
              <div class="flex items-center">
                <input type="checkbox" id="division" checked class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                <label for="division" class="ml-2 text-sm text-gray-700">除法 (÷)</label>
              </div>
              <div class="flex items-center">
                <input type="checkbox" id="comparison" checked class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                <label for="comparison" class="ml-2 text-sm text-gray-700">比较 (<, >, =)</label>
              </div>
              <div class="flex items-center">
                <input type="checkbox" id="brackets" checked class="h-4 w-4 text-primary border-gray-300 rounded focus:ring-primary">
                <label for="brackets" class="ml-2 text-sm text-gray-700">括号运算</label>
              </div>
            </div>
          </div>
          
          <!-- 格式设置（只保留PDF） -->
          <div class="setting-group">
            <label class="block text-sm font-medium text-gray-700 mb-2">
              <i class="fa fa-file-text-o text-primary mr-1"></i> 导出格式
            </label>
            <div class="grid grid-cols-1 gap-3">
              <div class="relative">
                <input 
                  type="radio" 
                  id="formatPdf" 
                  name="format" 
                  value="pdf" 
                  checked
                  class="sr-only peer"
                >
                <label 
                  for="formatPdf" 
                  class="block text-center px-3 py-3 border border-gray-300 rounded-lg cursor-pointer transition-all peer-checked:border-primary peer-checked:bg-primary/5"
                >
                  <i class="fa fa-file-pdf-o block text-lg mb-1 text-red-600"></i>
                  <span class="text-sm">PDF</span>
                </label>
              </div>
            </div>
          </div>
          
          <!-- 按钮区域 -->
          <div class="flex flex-col sm:flex-row gap-3 pt-4">
            <button 
              id="generateBtn" 
              class="flex-1 bg-primary text-white py-3 px-4 rounded-lg font-medium btn-effect flex items-center justify-center"
            >
              <i class="fa fa-refresh mr-2"></i> 生成题目
            </button>
            <button 
              id="exportBtn" 
              class="flex-1 bg-secondary text-white py-3 px-4 rounded-lg font-medium btn-effect flex items-center justify-center"
            >
              <i class="fa fa-download mr-2"></i> 导出PDF
            </button>
          </div>
        </div>
      </div>
      
      <!-- 右侧题目显示区域（根据行列设置和题目数量自动分页） -->
      <div class="lg:col-span-2">
        <div class="bg-white rounded-xl shadow-card p-6 transition-all duration-300 hover:shadow-card-hover h-full">
          <div class="flex justify-between items-center mb-6">
            <h2 class="text-lg font-semibold text-gray-800 flex items-center">
              <i class="fa fa-list-alt text-primary mr-2"></i> 生成的题目
            </h2>
            <div class="text-sm text-gray-500 bg-neutral px-3 py-1 rounded-full">
              <span id="questionStats">0 题</span> · <span id="pageStats">0 页</span>
            </div>
          </div>
          
          <!-- 初始提示 -->
          <div id="initialMessage" class="text-center py-16 text-gray-500">
            <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-primary/10 mb-4">
              <i class="fa fa-lightbulb-o text-2xl text-primary"></i>
            </div>
            <p class="text-gray-600">请设置题目参数并点击"生成题目"按钮</p>
          </div>
          
          <!-- 分页导航 -->
          <div id="paginationControls" class="hidden mb-6 flex justify-between items-center">
            <button id="prevPage" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 btn-effect disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none" disabled>
              <i class="fa fa-chevron-left mr-1"></i> 上一页
            </button>
            <div class="text-sm text-gray-600">
              第 <span id="currentPage">1</span> 页 / 共 <span id="totalPages">0</span> 页
            </div>
            <button id="nextPage" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 btn-effect disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none" disabled>
              下一页 <i class="fa fa-chevron-right ml-1"></i>
            </button>
          </div>
          
          <!-- 题目容器（根据列数设置动态调整并分页） -->
          <div id="questionsContainer" class="hidden">
            <div id="questionsPages" class="space-y-8">
              <!-- 页面内容将在这里动态生成 -->
            </div>
          </div>
          
          <!-- 答案区域分页 -->
          <div class="mt-8 pt-6 border-t border-gray-100">
            <button id="toggleAnswersBtn" class="text-primary hover:text-primary/80 text-sm font-medium flex items-center btn-effect px-2 py-1 rounded">
              <i class="fa fa-eye mr-1"></i>
              <span>显示答案</span>
            </button>
            
            <div id="answersPaginationControls" class="hidden mt-4 flex justify-between items-center">
              <button id="prevAnswerPage" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 btn-effect disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none" disabled>
                <i class="fa fa-chevron-left mr-1"></i> 上一页
              </button>
              <div class="text-sm text-gray-600">
                第 <span id="currentAnswerPage">1</span> 页 / 共 <span id="totalAnswerPages">0</span> 页
              </div>
              <button id="nextAnswerPage" class="px-4 py-2 border border-gray-300 rounded-lg text-gray-700 btn-effect disabled:opacity-50 disabled:cursor-not-allowed disabled:hover:translate-y-0 disabled:hover:shadow-none" disabled>
                下一页 <i class="fa fa-chevron-right ml-1"></i>
              </button>
            </div>
            
            <div id="answersContainer" class="hidden mt-4 space-y-8">
              <!-- 答案页面将在这里动态生成 -->
            </div>
          </div>
          
          <!-- 加载状态 -->
          <div id="loadingIndicator" class="hidden text-center py-16">
            <div class="inline-block animate-spin rounded-full h-10 w-10 border-4 border-primary border-t-transparent mb-4"></div>
            <p class="text-gray-600">正在生成题目...</p>
          </div>
        </div>
      </div>
    </div>
  </main>

  <footer class="bg-white border-t border-gray-100 mt-12">
    <div class="container mx-auto px-4 py-8">
      <div class="text-center text-gray-500 text-sm">
        <p>运算题生成器 &copy; 2023 - 灵活排版，自定义练习</p>
        <p class="mt-1">专为教育场景设计，提升练习效率</p>
      </div>
    </div>
  </footer>

  <script>
    // 全局变量存储生成的题目和答案
    let generatedQuestions = [];
    let generatedAnswers = [];
    let questionPages = [];  // 分页后的题目
    let answerPages = [];    // 分页后的答案
    let currentPage = 1;     // 当前题目页
    let currentAnswerPage = 1; // 当前答案页
    
    // DOM 元素
    const generateBtn = document.getElementById('generateBtn');
    const exportBtn = document.getElementById('exportBtn');
    const toggleAnswersBtn = document.getElementById('toggleAnswersBtn');
    const questionCountInput = document.getElementById('questionCount');
    const numberRangeInput = document.getElementById('numberRange');
    const fontSizeInput = document.getElementById('fontSize');
    const rowCountInput = document.getElementById('rowCount');
    const colCountInput = document.getElementById('colCount');
    const includeAnswersCheckbox = document.getElementById('includeAnswers');
    const answersOnNewPageCheckbox = document.getElementById('answersOnNewPage');
    const questionsPages = document.getElementById('questionsPages');
    const answersContainer = document.getElementById('answersContainer');
    const initialMessage = document.getElementById('initialMessage');
    const questionsContainer = document.getElementById('questionsContainer');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const questionStats = document.getElementById('questionStats');
    const pageStats = document.getElementById('pageStats');
    const header = document.querySelector('header');
    
    // 分页控制元素
    const paginationControls = document.getElementById('paginationControls');
    const prevPageBtn = document.getElementById('prevPage');
    const nextPageBtn = document.getElementById('nextPage');
    const currentPageEl = document.getElementById('currentPage');
    const totalPagesEl = document.getElementById('totalPages');
    
    // 答案分页控制元素
    const answersPaginationControls = document.getElementById('answersPaginationControls');
    const prevAnswerPageBtn = document.getElementById('prevAnswerPage');
    const nextAnswerPageBtn = document.getElementById('nextAnswerPage');
    const currentAnswerPageEl = document.getElementById('currentAnswerPage');
    const totalAnswerPagesEl = document.getElementById('totalAnswerPages');
    
    // 计算每页可容纳的题目数量（默认40行×6列=240题/页）
    function getQuestionsPerPage() {
      const rowCount = parseInt(rowCountInput.value) || 40;
      const colCount = parseInt(colCountInput.value) || 6;
      return rowCount * colCount;
    }
    
    // 分割题目为页面组
    function splitIntoPages(items) {
      const pages = [];
      const questionsPerPage = getQuestionsPerPage();
      
      for (let i = 0; i < items.length; i += questionsPerPage) {
        pages.push(items.slice(i, i + questionsPerPage));
      }
      
      return pages;
    }
    
    // 更新分页显示
    function updatePagination() {
      const totalPages = questionPages.length;
      
      // 更新分页信息
      currentPageEl.textContent = currentPage;
      totalPagesEl.textContent = totalPages;
      
      // 更新分页按钮状态
      prevPageBtn.disabled = currentPage <= 1;
      nextPageBtn.disabled = currentPage >= totalPages;
      
      // 显示或隐藏所有页面
      const pageElements = questionsPages.querySelectorAll('.question-page');
      pageElements.forEach((page, index) => {
        page.classList.toggle('hidden', index + 1 !== currentPage);
      });
      
      // 更新统计信息
      pageStats.textContent = `${totalPages} 页`;
    }
    
    // 更新答案分页显示
    function updateAnswerPagination() {
      const totalAnswerPages = answerPages.length;
      
      // 更新分页信息
      currentAnswerPageEl.textContent = currentAnswerPage;
      totalAnswerPagesEl.textContent = totalAnswerPages;
      
      // 更新分页按钮状态
      prevAnswerPageBtn.disabled = currentAnswerPage <= 1;
      nextAnswerPageBtn.disabled = currentAnswerPage >= totalAnswerPages;
      
      // 显示或隐藏所有答案页面
      const answerPageElements = answersContainer.querySelectorAll('.answer-page');
      answerPageElements.forEach((page, index) => {
        page.classList.toggle('hidden', index + 1 !== currentAnswerPage);
      });
    }
    
    // 行列数变化时重新分页并更新预览
    function updateLayoutAndPagination() {
      if (generatedQuestions.length === 0) return;
      
      // 重新分页
      questionPages = splitIntoPages(generatedQuestions);
      answerPages = splitIntoPages(generatedAnswers);
      
      // 重置当前页
      currentPage = 1;
      currentAnswerPage = 1;
      
      // 重新渲染页面
      renderQuestionPages();
      renderAnswerPages();
      
      // 更新分页控件
      updatePagination();
      updateAnswerPagination();
    }
    
    // 监听行列数变化
    rowCountInput.addEventListener('input', updateLayoutAndPagination);
    colCountInput.addEventListener('input', updateLayoutAndPagination);
    fontSizeInput.addEventListener('input', updateLayoutAndPagination);
    
    // 分页按钮事件
    prevPageBtn.addEventListener('click', () => {
      if (currentPage > 1) {
        currentPage--;
        updatePagination();
        scrollToTopOfContainer();
      }
    });
    
    nextPageBtn.addEventListener('click', () => {
      if (currentPage < questionPages.length) {
        currentPage++;
        updatePagination();
        scrollToTopOfContainer();
      }
    });
    
    // 答案分页按钮事件
    prevAnswerPageBtn.addEventListener('click', () => {
      if (currentAnswerPage > 1) {
        currentAnswerPage--;
        updateAnswerPagination();
        scrollToTopOfAnswers();
      }
    });
    
    nextAnswerPageBtn.addEventListener('click', () => {
      if (currentAnswerPage < answerPages.length) {
        currentAnswerPage++;
        updateAnswerPagination();
        scrollToTopOfAnswers();
      }
    });
    
    // 滚动到容器顶部
    function scrollToTopOfContainer() {
      questionsContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    function scrollToTopOfAnswers() {
      answersContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
    
    // 滚动时导航栏效果
    window.addEventListener('scroll', () => {
      if (window.scrollY > 10) {
        header.classList.add('shadow');
      } else {
        header.classList.remove('shadow');
      }
    });
    
    // 生成题目
    generateBtn.addEventListener('click', generateQuestions);
    
    // 导出题目
    exportBtn.addEventListener('click', exportQuestions);
    
    // 切换答案显示/隐藏
    toggleAnswersBtn.addEventListener('click', () => {
      const isHidden = answersContainer.classList.toggle('hidden');
      const icon = toggleAnswersBtn.querySelector('i');
      const text = toggleAnswersBtn.querySelector('span');
      
      if (isHidden) {
        icon.className = 'fa fa-eye mr-1';
        text.textContent = '显示答案';
        answersPaginationControls.classList.add('hidden');
      } else {
        icon.className = 'fa fa-eye-slash mr-1';
        text.textContent = '隐藏答案';
        answersPaginationControls.classList.remove('hidden');
        updateAnswerPagination();
      }
    });
    
    // 获取纸张尺寸信息 (只保留A4)
    function getPaperDimensions() {
      return {
        width: 210,   // A4宽度
        height: 297,  // A4高度
        margin: 20,   // 边距
        contentWidth: 210 - 40,  // 内容宽度
        contentHeight: 297 - 40  // 内容高度
      };
    }
    
    // 渲染题目页面
    function renderQuestionPages() {
      questionsPages.innerHTML = '';
      const colCount = parseInt(colCountInput.value) || 6;
      const fontSize = parseInt(fontSizeInput.value) || 14; // 默认14px
      
      questionPages.forEach((page, pageIndex) => {
        const pageElement = document.createElement('div');
        pageElement.className = `question-page ${pageIndex === 0 ? '' : 'hidden'} page-shadow rounded-lg p-6 bg-white page-transition`;
        
        // 添加页码标题
        pageElement.innerHTML = `<h3 class="text-sm text-gray-500 mb-4">第 ${pageIndex + 1} 页</h3>`;
        
        // 创建题目网格
        const gridElement = document.createElement('div');
        gridElement.className = `grid grid-cols-${colCount} gap-3`;
        
        // 添加题目
        page.forEach((question, index) => {
          const questionEl = document.createElement('div');
          questionEl.className = 'flex items-center p-3 border border-gray-100 rounded-lg hover:bg-neutral transition-colors';
          questionEl.style.fontSize = `${fontSize}px`; // 应用px字体大小
          questionEl.innerHTML = `
            <span class="text-gray-800">${question}</span>
            <span class="flex-1 border-b border-gray-300 mx-2"></span>
          `;
          gridElement.appendChild(questionEl);
        });
        
        pageElement.appendChild(gridElement);
        questionsPages.appendChild(pageElement);
      });
    }
    
    // 渲染答案页面
    function renderAnswerPages() {
      answersContainer.innerHTML = '';
      const colCount = parseInt(colCountInput.value) || 6;
      const fontSize = parseInt(fontSizeInput.value) || 14; // 默认14px
      
      answerPages.forEach((page, pageIndex) => {
        const pageElement = document.createElement('div');
        pageElement.className = `answer-page ${pageIndex === 0 ? '' : 'hidden'} page-shadow rounded-lg p-6 bg-white page-transition`;
        
        // 添加页码标题
        pageElement.innerHTML = `<h3 class="text-sm text-gray-500 mb-4">答案 - 第 ${pageIndex + 1} 页</h3>`;
        
        // 创建答案网格
        const gridElement = document.createElement('div');
        gridElement.className = `grid grid-cols-${colCount} gap-3`;
        
        // 添加答案
        page.forEach((answer, index) => {
          const answerEl = document.createElement('div');
          answerEl.className = 'p-3 border border-gray-100 rounded-lg bg-neutral';
          answerEl.style.fontSize = `${fontSize}px`; // 应用px字体大小
          answerEl.textContent = answer;
          gridElement.appendChild(answerEl);
        });
        
        pageElement.appendChild(gridElement);
        answersContainer.appendChild(pageElement);
      });
    }
    
    // 生成题目函数
    function generateQuestions() {
      // 验证输入
      const questionCount = parseInt(questionCountInput.value);
      const numberRange = parseInt(numberRangeInput.value);
      const fontSize = parseInt(fontSizeInput.value);
      const rowCount = parseInt(rowCountInput.value);
      const colCount = parseInt(colCountInput.value);
      
      if (isNaN(questionCount) || questionCount < 1 || questionCount > 500) {
        showNotification('请输入有效的题目数量（1-500）', 'error');
        return;
      }
      
      if (isNaN(numberRange) || numberRange < 10 || numberRange > 1000) {
        showNotification('请输入有效的数字范围（10-1000）', 'error');
        return;
      }
      
      if (isNaN(fontSize) || fontSize < 8 || fontSize > 24) {
        showNotification('请输入有效的字号（8-24px）', 'error');
        return;
      }
      
      if (isNaN(rowCount) || rowCount < 5 || rowCount > 40) {
        showNotification('请输入有效的行数（5-40）', 'error');
        return;
      }
      
      if (isNaN(colCount) || colCount < 1 || colCount > 6) {
        showNotification('请输入有效的列数（1-6）', 'error');
        return;
      }
      
      // 检查至少选择了一种运算类型
      const operations = [];
      if (document.getElementById('addition').checked) operations.push('addition');
      if (document.getElementById('subtraction').checked) operations.push('subtraction');
      if (document.getElementById('multiplication').checked) operations.push('multiplication');
      if (document.getElementById('division').checked) operations.push('division');
      if (document.getElementById('comparison').checked) operations.push('comparison');
      if (document.getElementById('brackets').checked) operations.push('brackets');
      
      if (operations.length === 0) {
        showNotification('请至少选择一种运算类型', 'error');
        return;
      }
      
      // 显示加载状态
      initialMessage.classList.add('hidden');
      questionsContainer.classList.add('hidden');
      paginationControls.classList.add('hidden');
      answersContainer.classList.add('hidden');
      answersPaginationControls.classList.add('hidden');
      loadingIndicator.classList.remove('hidden');
      
      // 模拟加载延迟
      setTimeout(() => {
        generatedQuestions = [];
        generatedAnswers = [];
        
        // 生成题目
        for (let i = 0; i < questionCount; i++) {
          // 随机选择运算类型
          const operationType = operations[Math.floor(Math.random() * operations.length)];
          let questionText, result;
          
          switch (operationType) {
            case 'addition':
              [questionText, result] = generateAdditionQuestion(numberRange);
              break;
            case 'subtraction':
              [questionText, result] = generateSubtractionQuestion(numberRange);
              break;
            case 'multiplication':
              [questionText, result] = generateMultiplicationQuestion(numberRange);
              break;
            case 'division':
              [questionText, result] = generateDivisionQuestion(numberRange);
              break;
            case 'comparison':
              [questionText, result] = generateComparisonQuestion(numberRange);
              break;
            case 'brackets':
              [questionText, result] = generateBracketQuestion(numberRange);
              break;
          }
          
          // 保存题目和答案
          generatedQuestions.push(questionText);
          generatedAnswers.push(`${questionText} ${result}`);
        }
        
        // 分页处理（默认40×6=240题/页）
        questionPages = splitIntoPages(generatedQuestions);
        answerPages = splitIntoPages(generatedAnswers);
        
        // 重置当前页
        currentPage = 1;
        currentAnswerPage = 1;
        
        // 渲染页面
        renderQuestionPages();
        renderAnswerPages();
        
        // 更新统计信息
        questionStats.textContent = `${questionCount} 题`;
        pageStats.textContent = `${questionPages.length} 页`;
        
        // 隐藏加载状态，显示题目和分页控件
        loadingIndicator.classList.add('hidden');
        questionsContainer.classList.remove('hidden');
        paginationControls.classList.remove('hidden');
        
        // 更新分页控件
        updatePagination();
        updateAnswerPagination();
        
        showNotification(`成功生成 ${questionCount} 道题目，共 ${questionPages.length} 页。请检查预览效果，必要时调整设置。`, 'success');
        
      }, 600);
    }
    
    // 生成各类题目
    function generateAdditionQuestion(range) {
      const num1 = Math.floor(Math.random() * range) + 1;
      const maxNum2 = Math.min(range - num1, range);
      const num2 = Math.floor(Math.random() * maxNum2) + 1;
      const result = num1 + num2;
      return [`${num1} + ${num2} =`, result];
    }
    
    function generateSubtractionQuestion(range) {
      const num1 = Math.floor(Math.random() * range) + 1;
      const num2 = Math.floor(Math.random() * num1) + 1;
      const result = num1 - num2;
      return [`${num1} - ${num2} =`, result];
    }
    
    function generateMultiplicationQuestion(range) {
      const maxFactor = Math.floor(Math.sqrt(range)) + 1;
      const num1 = Math.floor(Math.random() * maxFactor) + 1;
      const num2 = Math.floor(Math.random() * maxFactor) + 1;
      const result = num1 * num2;
      return [`${num1} × ${num2} =`, result];
    }
    
    function generateDivisionQuestion(range) {
      const num2 = Math.floor(Math.random() * (range - 1)) + 1;
      const maxQuotient = Math.floor(range / num2);
      const quotient = Math.floor(Math.random() * maxQuotient) + 1;
      const num1 = num2 * quotient;
      return [`${num1} ÷ ${num2} =`, quotient];
    }
    
    function generateComparisonQuestion(range) {
      const num1 = Math.floor(Math.random() * range) + 1;
      const num2 = Math.floor(Math.random() * range) + 1;
      let operator;
      
      if (num1 > num2) operator = ">";
      else if (num1 < num2) operator = "<";
      else operator = "=";
      
      return [`${num1} ${operator} ${num2}`, ""];
    }
    
    function generateBracketQuestion(range) {
      const num1 = Math.floor(Math.random() * range / 2) + 1;
      const num2 = Math.floor(Math.random() * range / 2) + 1;
      const num3 = Math.floor(Math.random() * range / 3) + 1;
      
      // 随机选择括号内的运算
      const innerOps = ["+", "-"];
      const innerOp = innerOps[Math.floor(Math.random() * innerOps.length)];
      
      // 随机选择括号外的运算
      const outerOps = ["+", "-", "×"];
      const outerOp = outerOps[Math.floor(Math.random() * outerOps.length)];
      
      // 计算结果
      let innerResult = innerOp === "+" ? num1 + num2 : Math.max(num1, num2) - Math.min(num1, num2);
      let result;
      
      if (outerOp === "+") result = innerResult + num3;
      else if (outerOp === "-") {
        result = innerResult - num3;
        if (result < 0) {
          result = num3 - innerResult;
          return [`${num3} - (${num1} ${innerOp} ${num2}) =`, result];
        }
      } else result = innerResult * num3;
      
      return [`(${num1} ${innerOp} ${num2}) ${outerOp} ${num3} =`, result];
    }
    
    // 导出题目函数
    function exportQuestions() {
      if (generatedQuestions.length === 0) {
        showNotification('请先生成题目', 'error');
        return;
      }
      
      // 获取设置
      const paper = getPaperDimensions();
      const fontSize = parseInt(fontSizeInput.value) || 14; // 默认14px
      const rowCount = parseInt(rowCountInput.value) || 40; // 默认40行
      const colCount = parseInt(colCountInput.value) || 6; // 默认6列
      const includeAnswers = includeAnswersCheckbox.checked;
      const answersOnNewPage = answersOnNewPageCheckbox.checked;
      
      // 生成文件名
      const date = new Date();
      const numberRange = numberRangeInput.value;
      const fileName = `${numberRange}以内运算题_A4_${date.getFullYear()}${(date.getMonth()+1).toString().padStart(2,'0')}${date.getDate().toString().padStart(2,'0')}`;
      
      // 显示导出中提示
      showNotification('正在导出为PDF格式...', 'info');
      exportAsPdf(fileName, paper, fontSize, rowCount, colCount, includeAnswers, answersOnNewPage);
    }
    
    // 计算排版参数（适配px单位）
    function calculateLayoutParams(paper, fontSize, rowCount, colCount) {
      // 计算每页可容纳的题目数量
      const questionsPerPage = rowCount * colCount;
      
      // 计算行高 (字体大小的1.6倍)，px转mm的转换率约为0.264583
      const lineHeight = fontSize * 1.6 * 0.264583;
      
      return { 
        questionsPerPage,
        lineHeight
      };
    }
    
    // 导出为PDF
    function exportAsPdf(fileName, paper, fontSize, rowCount, colCount, includeAnswers, answersOnNewPage) {
      const questionCount = generatedQuestions.length;
      const layout = calculateLayoutParams(paper, fontSize, rowCount, colCount);
      
      // 创建PDF文档
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'mm', [paper.width, paper.height]);
      
      // 转换px到pt (1px ≈ 0.75pt)
      const fontSizePt = fontSize * 0.75;
      
      // 添加题目页面
      questionPages.forEach((page, pageIndex) => {
        // 不是第一页则添加新页面
        if (pageIndex > 0) {
          pdf.addPage();
        }
        
        // 设置字体大小（转换为pt）
        pdf.setFontSize(fontSizePt);
        
        // 计算网格位置和尺寸
        const startX = paper.margin;
        const startY = paper.margin + 10; // 从页边距下方10mm开始
        const columnWidth = (paper.contentWidth) / colCount;
        const rowHeight = layout.lineHeight;
        
        // 添加题目到网格
        page.forEach((question, index) => {
          const row = Math.floor(index / colCount);
          const col = index % colCount;
          const x = startX + (col * columnWidth) + 5; // +5 增加左侧内边距
          const y = startY + (row * rowHeight);
          
          // 确保内容在页面范围内
          if (y + rowHeight < paper.height - paper.margin) {
            pdf.text(question, x, y);
          }
        });
      });
      
      // 添加答案页面
      if (includeAnswers && answerPages.length > 0) {
        answerPages.forEach((page, pageIndex) => {
          // 添加新页面
          pdf.addPage();
          
          // 设置字体大小（转换为pt）
          pdf.setFontSize(fontSizePt);
          
          // 计算网格位置和尺寸
          const startX = paper.margin;
          const startY = paper.margin + 10; // 从页边距下方10mm开始
          const columnWidth = (paper.contentWidth) / colCount;
          const rowHeight = layout.lineHeight;
          
          // 添加答案到网格
          page.forEach((answer, index) => {
            const row = Math.floor(index / colCount);
            const col = index % colCount;
            const x = startX + (col * columnWidth) + 5;
            const y = startY + (row * rowHeight);
            
            // 确保内容在页面范围内
            if (y + rowHeight < paper.height - paper.margin) {
              pdf.text(answer, x, y);
            }
          });
        });
      }
      
      pdf.save(`${fileName}.pdf`);
      setTimeout(() => {
        showNotification('PDF导出成功', 'success');
      }, 1000);
    }
    
    // 获取选中的运算类型文本
    function getOperationTypesText() {
      const types = [];
      if (document.getElementById('addition').checked) types.push('加法');
      if (document.getElementById('subtraction').checked) types.push('减法');
      if (document.getElementById('multiplication').checked) types.push('乘法');
      if (document.getElementById('division').checked) types.push('除法');
      if (document.getElementById('comparison').checked) types.push('比较');
      if (document.getElementById('brackets').checked) types.push('括号运算');
      
      return types.join('、');
    }
    
    // 显示通知提示
    function showNotification(message, type = 'info') {
      // 创建通知元素
      const notification = document.createElement('div');
      
      // 设置样式和图标
      let bgColor, icon;
      switch(type) {
        case 'success':
          bgColor = 'bg-secondary';
          icon = 'fa-check-circle';
          break;
        case 'error':
          bgColor = 'bg-red-500';
          icon = 'fa-exclamation-circle';
          break;
        case 'info':
        default:
          bgColor = 'bg-primary';
          icon = 'fa-info-circle';
      }
      
      notification.className = `${bgColor} text-white px-4 py-3 rounded-lg shadow-lg fixed bottom-4 right-4 transform translate-y-20 opacity-0 transition-all duration-300 flex items-center z-50`;
      notification.innerHTML = `
        <i class="fa ${icon} mr-2"></i>
        <span>${message}</span>
      `;
      
      // 添加到页面
      document.body.appendChild(notification);
      
      // 显示动画
      setTimeout(() => {
        notification.classList.remove('translate-y-20', 'opacity-0');
      }, 100);
      
      // 自动消失
      setTimeout(() => {
        notification.classList.add('translate-y-20', 'opacity-0');
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }
    
    // 页面加载动画
    document.addEventListener('DOMContentLoaded', () => {
      const mainContent = document.querySelector('main');
      mainContent.classList.add('opacity-0', 'transition-opacity', 'duration-500');
      
      setTimeout(() => {
        mainContent.classList.remove('opacity-0');
      }, 300);
    });
  </script>
</body>
</html>